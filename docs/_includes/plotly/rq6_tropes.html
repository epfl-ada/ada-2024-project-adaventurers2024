<div class="mt-5">
    <h1 class="mb-4">Genre-Based Tropes Plot</h1>

    <p class="mb-4">A trope is a common pattern or theme that is frequently used in storytelling across various genres. In this plot, we explore the top tropes in different movie genres. The y-axis shows the tropes, while the x-axis represents the ratio of each trope in the respective genre.</p>

    <div class="row align-items-center">
        <p class="mb-4">Please select a genre to view the top 5 tropes:</p>

        <div class="dropdown ml-2">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="genreDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Select genre
            </button>
            <div class="dropdown-menu" aria-labelledby="genreDropdown" id="genreMenu">
                <a class="dropdown-item" href="#" data-genre="All">All</a>
                <a class="dropdown-item" href="#" data-genre="Crime">Crime</a>
                <a class="dropdown-item" href="#" data-genre="Romance">Romance</a>
                <a class="dropdown-item" href="#" data-genre="Horror">Horror</a>
                <a class="dropdown-item" href="#" data-genre="Fantasy">Fantasy</a>
                <a class="dropdown-item" href="#" data-genre="Drama">Drama</a>
                <a class="dropdown-item" href="#" data-genre="Science">Science</a>
                <a class="dropdown-item" href="#" data-genre="Mystery">Mystery</a>
                <a class="dropdown-item" href="#" data-genre="Family">Family</a>
                <a class="dropdown-item" href="#" data-genre="Action">Action</a>
                <a class="dropdown-item" href="#" data-genre="Comedy">Comedy</a>
                <a class="dropdown-item" href="#" data-genre="Thriller">Thriller</a>
                <a class="dropdown-item" href="#" data-genre="Adventure">Adventure</a>
            </div>
        </div>
    </div>

    <div id="rq6-plot"></div>

    <div class="text-justify mt-4">
        <p>You can also explore a trope in more detail by selecting it from the plot above:</p>
        <p><strong>Selected trope: </strong><span id="tropeTitle"></span></p>
        <p><strong>Description: </strong>
            <span id="tropeDescription"></span>
            <span id="dots">...</span>
            <span id="more" style="display: none;"></span>
            <button id="seeMoreBtn" style="display: none;" class="btn btn-link">See more</button>
        </p>
        
        <p><strong>Example: </strong><span id="tropeExample"></span></p>
        <img alt="Trope Image" id="tropeImage" class="mx-auto d-block"/>
    </div>
</div>

<script>
    document.querySelectorAll('#genreMenu .dropdown-item').forEach(item => {
        item.addEventListener('click', function () {
            event.preventDefault();
            const genre = this.getAttribute('data-genre');
            document.getElementById('genreDropdown').textContent = genre;

            // Fetch data dynamically based on the selected genre
            fetch(`/assets/data/${genre.toLowerCase()}_tropes.json`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const processedData = processGenreData(data);
                    updatePlot(processedData, genre);
                    updateTropeInfo(data[0]);
                })
                .catch(error => console.error('Error loading data:', error));
        });
    });

    // Function to process the fetched data (replace with your logic)
    function processGenreData(data) {
        return {
            y: data.map(item => item.trope),
            x: data.map(item => item.ratio),
            type: 'bar',
            marker: { 
                color: data.map((item, index) => {
                    // Start with a deep blue and gradually move towards lighter shades
                    const blue = Math.floor(255 - index * 15);  // Gradual shift from deep blue
                    const green = Math.floor(100 + index * 15); // Increase green over the gradient
                    const red = Math.floor(20 + index * 10);   // Gradual increase in red for the gradient
                    return `rgba(${red}, ${green}, ${blue}, 0.8)`;
                }),
                width: 1
            },
            orientation: 'h',
            tropes: data
        };
    }

    // Function to update the Plotly plot
    function updatePlot(plotData, genre) {
        var plot = document.getElementById('rq6-plot');
        const layout = {
            title: `Top Tropes in ${genre} Movies`,
            margin: { l: 150, r: 50, t: 50, b: 50 },
            yaxis: { title: 'Tropes', automargin: true , autorange: 'reversed' },
            xaxis: { title: 'Ratio' },
            modebar: { orientation: 'v' }
        };
        Plotly.newPlot('rq6-plot', [plotData], layout);

        plot.on('plotly_click', function(plotData){
            trope = plotData.points[0].label;
            selectedTrope = plotData.points[0].data.tropes.find(item => item.trope === trope);
            updateTropeInfo(selectedTrope);
        });
    }

    function updateTropeInfo(trope) {
        document.getElementById('tropeTitle').textContent = trope.trope;
        document.getElementById('tropeDescription').textContent = trope.description;
        document.getElementById('tropeExample').textContent = trope.example;
        document.getElementById('tropeImage').src = trope.img_url;

        const descriptionElement = document.getElementById("tropeDescription");
        const moreElement = document.getElementById("more");
        const dots = document.getElementById("dots");
        const seeMoreBtn = document.getElementById("seeMoreBtn");

        const fullDescription = descriptionElement.innerText;
        const wordLimit = 100;

        if (fullDescription.split(" ").length > wordLimit) {
            const truncatedText = fullDescription.split(" ").slice(0, wordLimit).join(" ");

            descriptionElement.innerText = truncatedText;
            moreElement.innerText = fullDescription.slice(truncatedText.length);
            seeMoreBtn.style.display = "inline";

            seeMoreBtn.addEventListener("click", function () {
                if (dots.style.display === "none") {
                    dots.style.display = "inline";
                    moreElement.style.display = "none";
                    seeMoreBtn.innerText = "See more";
                } else {
                    dots.style.display = "none";
                    moreElement.style.display = "inline";
                    seeMoreBtn.innerText = "See less";
                }
            });
        }
    }

    // Load the default data on page load
    fetch(`/assets/data/all_tropes.json`)
        .then(response => response.json())
        .then(data => {
            const processedData = processGenreData(data);
            updateTropeInfo(data[0]);
            updatePlot(processedData, 'All');

            document.getElementById('genreDropdown').textContent = 'All';
        })
        .catch(error => console.error('Error loading default data:', error));

</script>

<style>
    .row.align-items-center {
        display: flex;
        align-items: center;
    }

    .btn-outline-secondary:hover {
        background-color: rgb(47, 116, 255);
        border-color: white;
    }

    #tropeImage {
        max-height: 300px;
    }
</style>